define(["jquery","core/modal_factory","core/modal_events","core/str","core/config","enrol_payment/spin"],function(h,o,n,i,a,e){return{mdlstr:void 0,gateway:null,originalCost:void 0,subtotal:void 0,taxPercent:void 0,taxAmount:void 0,instanceid:void 0,prepayToken:void 0,billingAddressRequired:void 0,validateZipCode:void 0,shippingAddressRequired:void 0,userEmail:void 0,currency:void 0,symbol:void 0,MultipleRegistration:{enabled:!1,nextEmailID:1,getEmails:function(){var t=[];return h(".mr-email-line input").each(function(){var e=h(this).val();""!==h.trim(e)&&t.push(e)}),t},addPlusClickHandler:function(e,i){var n=this;e.click(function(){var e=n.makeEmailEntryLine(i);h(".plus-container").remove();var t=h("#multiple-registration-container").append(e);n.addPlusClickHandler(h(".plus-container"),i),n.addMinusClickHandler(t.find(".minus-container"),i)})},addMinusClickHandler:function(e,t){var i=this;e.click(function(){h(this).parent().remove(),h(".mr-email-line:last .plus-container").length||(h(".mr-email-line:last").append(i.makePlusSign(t)),i.addPlusClickHandler(h(".plus-container"),t)),i.refreshEmailNums()})},makePlusSign:function(e){return'<div class="plus-container" title="'+e.addaregistrant+'"><img src="'+a.wwwroot+'/enrol/payment/pix/user_add.gif" class="plus"></div>'},makePlusAndMinusSigns:function(e,t){var i=this.makePlusSign(t),n='<div class="minus-container" title="'+t.removearegistrant+'"><img src="'+a.wwwroot+'/enrol/payment/pix/user_delete.gif" class="minus"></div>';return 1<e?i+n:i},refreshEmailNums:function(){var t=-1;return h(".email-num").each(function(e){h(this).text(e+1),t=e}),t+2},makeEmailEntryLine:function(e){var t=this,i=t.refreshEmailNums(),n=t.nextEmailID;t.nextEmailID=t.nextEmailID+1;var a='"multiple-registration-email-'+n+'"';return'<div class="mr-email-line">'+('<div class="mr-email-label-container"><label for='+a+'>Email <span class="email-num">'+i+"</span>:&nbsp;&nbsp;&nbsp;</label></div>")+("<input id="+a+' type="text" class="multiple-registration-email" />')+this.makePlusAndMinusSigns(n,e)+"</div>"},checkoutConfirmModal:function(t,e){var i=h("#success-modal-trigger");i.off(),o.create({type:o.types.SAVE_CANCEL,title:t.mdlstr.confirmpurchase,body:e},i).done(function(e){e.setSaveButtonText(t.mdlstr.continue),e.getRoot().on(n.save,function(){t.checkoutFinal()}),t.removeDimmer(e)}),h("#success-modal-trigger").click()},handleEmailSubmitAJAXResponse:function(e,t){var i=JSON.parse(e);if(i.success)t.subtotal=i.subtotal,t.updateCostView(),this.checkoutConfirmModal(t,i.successmessage);else{var n=h("#error-modal-trigger");n.off(),o.create({type:o.types.DEFAULT,body:i.failmessage,closebuttontitle:t.mdlstr.dismiss},n).done(function(e){t.removeDimmer(e)}),h("#error-modal-trigger").click()}},verifyAndSubmit:function(t){var i=this;if("paypal"!==t.gateway&&"stripe"!==t.gateway)throw alert(t.mdlstr.invalidpaymentprovider),new Error(t.mdlstr.invlidpaymentprovider);var e=i.getEmails();if(e.length){var n=a.wwwroot+"/enrol/payment/ajax/multiple_enrol.php";h.ajax({url:n,method:"POST",data:{instanceid:t.instanceid,prepaytoken:t.prepayToken,emails:JSON.stringify(e),ipn_id:h("#"+t.gateway+"-custom").val(),symbol:t.symbol},context:document.body,success:function(e){i.handleEmailSubmitAJAXResponse(e,t)}})}else t.genericErrorModal(t.mdlstr.novalidemailsentered,t.mdlstr.novalidemailsentered_desc,"no-valid-emails-entered"),h("#dimmer").css("display","none")},buildForm:function(e,t){var i=this;i.enabled?(i.enabled=!1,e.text(t.enrolothers),e.removeClass("disable-mr").addClass("enable-mr"),h(".mr-email-line").remove(),h("#multiple-registration-btn-container img.iconhelp").css("display","inline-block")):(i.enabled=!0,i.nextEmailID=1,e.text(t.cancelenrolothers),e.removeClass("enable-mr").addClass("disable-mr"),h("#multiple-registration-container").html(this.makeEmailEntryLine(t)),i.addPlusClickHandler(h(".plus-container"),t),h("#multiple-registration-btn-container img.iconhelp").css("display","none"))}},Discount:{checkDiscountCode:function(i){var e=h("#discountcode").val(),t=a.wwwroot+"/enrol/payment/ajax/check_discount.php";h.ajax({url:t,data:{discountcode:e,instanceid:i.instanceid,prepaytoken:i.prepayToken},context:document.body,success:function(e){var t=JSON.parse(e);t.success?(h("#discount-dimmer").css("display","block"),i.subtotal=t.subtotal,i.updateCostView()):(h("#dimmer").css("display","block"),i.genericErrorModal(i.mdlstr.incorrectdiscountcode,t.failmessage,"invalid-code-modal"))},error:function(){h("#dimmer").css("display","block"),i.genericErrorModal(i.mdlstr.incorrectdiscountcode,i.mdlstr.incorrectdiscountcode_desc,"invalid-code-modal")}})}},checkoutFinal:function(){if(this.updateCostView(),"paypal"===this.gateway)h("#paypal-form input[name=amount]").val(this.subtotal),h("#paypal-form input[name=tax]").val(this.taxAmount),h("#paypal-form").submit();else{if("stripe"!==this.gateway)throw new Error(this.mdlstr.invalidgateway);h("#stripe-form input[name=amount]").val(this.getTaxedAmount()),h("#stripe-form input[name=tax]").val(this.taxAmount),this.stripeCheckout()}},getTaxedAmount:function(){return(parseFloat(this.subtotal)+parseFloat(this.taxAmount)).toFixed(2)},updateCostView:function(){this.taxAmount=Number.parseFloat(this.subtotal*this.taxPercent).toFixed(2),h("span.localisedcost-untaxed").text(Number.parseFloat(this.subtotal).toFixed(2)),h("span.localisedcost").text(this.getTaxedAmount()),h("span.subtotal-display").text(this.getTaxedAmount()),h("span.taxamountstring").text(Number.parseFloat(this.taxAmount).toFixed(2)),h("span#banktransfer-cost").text(this.symbol+this.getTaxedAmount())},stripeCheckout:function(){var e=this;h.getScript("https://checkout.stripe.com/checkout.js",function(){StripeCheckout.configure({key:e.stripePublishableKey,image:e.stripeLogo||"https://stripe.com/img/documentation/checkout/marketplace.png",locale:"auto",billingAddress:e.billingAddressRequired,shippingAddress:e.shippingAddressRequired,email:e.userEmail||null,allowRememberMe:!1,token:function(e){h("#stripe-form").append('<input type="hidden" name="stripeToken" value="'+e.id+'" />').append('<input type="hidden" name="stripeTokenType" value="'+e.type+'" />').append('<input type="hidden" name="stripeEmail" value="'+e.email+'" />').submit()}}).open({name:decodeURIComponent(e.courseFullName),description:e.mdlstr.totalenrolmentfee+" "+e.symbol+e.getTaxedAmount()+" "+e.currency,zipCode:e.validateZipCode?"true":"false",amount:Math.floor(100*Number.parseFloat(e.getTaxedAmount())),currency:e.currency,closed:function(){h("#dimmer").css("display","none")}})}).fail(function(){throw new Error("Could not load Stripe checkout library.")})},genericErrorModal:function(e,t,i){var n=this;0==h("#"+i).length&&h("#moodle-modals").append('<a id="'+i+'"></a>');var a=h("#moodle-modals #"+i);a.off(),o.create({type:o.types.DEFAULT,title:e,body:t},a).done(function(e){n.removeDimmer(e)}),a.click()},removeDimmer:function(e){e.getRoot().on(n.destroyed,function(){h("#dimmer").css("display","none")}),e.getRoot().on(n.cancel,function(){h("#dimmer").css("display","none")}),e.getRoot().on(n.hidden,function(){h("#dimmer").css("display","none")})},initClickHandlers:function(){var t=this;h("#apply-discount").click(function(){t.Discount.checkDiscountCode(t)}),h("#multiple-registration-btn").click(function(){t.MultipleRegistration.buildForm(h(this),t.mdlstr)}),h(".payment-checkout").click(function(e){h("#dimmer").css("display","block"),e.preventDefault(),"paypal-button"===e.target.id?t.gateway="paypal":"stripe-button"===e.target.id&&(t.gateway="stripe"),t.MultipleRegistration.enabled?t.MultipleRegistration.verifyAndSubmit(t):h.ajax({url:a.wwwroot+"/enrol/payment/ajax/single_enrol.php",method:"POST",data:{prepaytoken:t.prepayToken},success:function(){t.checkoutFinal()},error:function(){alert(t.mdlstr.errcommunicating)}})})},loadStrings:function(n,a){for(var e=[],t=0;t<n.length;t++)e.push({key:n[t],component:"enrol_payment"});i.get_strings(e).done(function(e){for(var t=[],i=0;i<n.length;i++)t[n[i]]=e[i];a(t)})},init:function(t,i,n,a,o,r,s,l,d,c,u,m,p){var g=this;g.loadStrings(["discounttypeerror","discountamounterror","invalidgateway","errcommunicating","addaregistrant","removearegistrant","enrolothers","cancelenrolothers","confirmpurchase","continue","dismiss","invalidpaymentprovider","novalidemailsentered","novalidemailsentered_desc","totalenrolmentfee","error","incorrectdiscountcode","incorrectdiscountcode_desc"],function(e){g.mdlstr=e,g.originalCost=parseFloat(n),g.taxPercent=parseFloat(l),g.subtotal=parseFloat(n),g.taxAmount=parseFloat(l*n),g.instanceid=t,g.stripePublishableKey=i,g.courseFullName=o,g.shippingAddressRequired=1==r,g.prepayToken=a,g.stripeLogo=s,g.validateZipCode=1==d,g.billingAddressRequired=1==c,g.userEmail=u,g.currency=m,g.symbol=p,g.initClickHandlers(),g.updateCostView(),h("#dimmer").css("display","none")})}}});