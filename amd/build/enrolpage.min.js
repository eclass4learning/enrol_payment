define(["jquery","core/modal_factory","core/modal_events","core/str","core/config","enrol_payment/spin"],function(a,b,c,d,e,f){var g={mdlstr:void 0,gateway:null,originalCost:void 0,subtotal:void 0,taxPercent:void 0,taxAmount:void 0,instanceid:void 0,prepayToken:void 0,billingAddressRequired:void 0,validateZipCode:void 0,shippingAddressRequired:void 0,userEmail:void 0,currency:void 0,symbol:void 0,discountCodeRequired:void 0,discountThreshold:void 0,MultipleRegistration:{enabled:!1,nextEmailID:1,getEmails:function(){var b=[];return a(".mr-email-line input").each(function(){var c=a(this).val();""!==a.trim(c)&&b.push(c)}),b},addPlusClickHandler:function(b,c){var d=this;b.click(function(){var b=d.makeEmailEntryLine(c);a(".plus-container").remove();var e=a("#multiple-registration-container").append(b);d.addPlusClickHandler(a(".plus-container"),c),d.addMinusClickHandler(e.find(".minus-container"),c)})},addMinusClickHandler:function(b,c){var d=this;b.click(function(){a(this).parent().remove(),a(".mr-email-line:last .plus-container").length||(a(".mr-email-line:last").append(d.makePlusSign(c)),d.addPlusClickHandler(a(".plus-container"),c)),d.refreshEmailNums()})},makePlusSign:function(a){var b='<div class="plus-container" title="'+a.addaregistrant+'"><img src="'+e.wwwroot+'/enrol/payment/pix/user_add.gif" class="plus"></div>';return b},makePlusAndMinusSigns:function(a,b){var c=this.makePlusSign(b),d='<div class="minus-container" title="'+b.removearegistrant+'"><img src="'+e.wwwroot+'/enrol/payment/pix/user_delete.gif" class="minus"></div>';return a>1?c+d:c},refreshEmailNums:function(){var b=-1;return a(".email-num").each(function(c){a(this).text(c+1),b=c}),b+2},makeEmailEntryLine:function(a){var b=this,c=b.refreshEmailNums(),d=b.nextEmailID;b.nextEmailID=b.nextEmailID+1;var e='"multiple-registration-email-'+d+'"',f='<div class="mr-email-line">',g='<div class="mr-email-label-container"><label for='+e+'>Email <span class="email-num">'+c+"</span>:&nbsp;&nbsp;&nbsp;</label></div>",h="<input id="+e+' type="text" class="multiple-registration-email" />',i="</div>";return f+g+h+this.makePlusAndMinusSigns(d,a)+i},checkoutConfirmModal:function(d,e){var f=a("#success-modal-trigger");f.off(),b.create({type:b.types.SAVE_CANCEL,title:d.mdlstr.confirmpurchase,body:e},f).done(function(a){a.setSaveButtonText(d.mdlstr["continue"]),a.getRoot().on(c.save,function(){d.checkoutFinal()}),d.removeDimmer(a)}),a("#success-modal-trigger").click()},handleEmailSubmitAJAXResponse:function(c,d){var e=this,f=JSON.parse(c);if(f.success)d.subtotal=f.subtotal,d.updateCostView(),e.checkoutConfirmModal(d,f.successmessage);else{var g=a("#error-modal-trigger");g.off(),b.create({type:b.types.DEFAULT,body:f.failmessage,closebuttontitle:d.mdlstr.dismiss},g).done(function(a){d.removeDimmer(a)}),a("#error-modal-trigger").click()}},verifyAndSubmit:function(b){var c=this;if("paypal"!==b.gateway&&"stripe"!==b.gateway)throw alert(b.mdlstr.invalidpaymentprovider),new Error(b.mdlstr.invlidpaymentprovider);var d=c.getEmails();if(d.length){var f=e.wwwroot+"/enrol/payment/ajax/multiple_enrol.php";a.ajax({url:f,method:"POST",data:{instanceid:b.instanceid,prepaytoken:b.prepayToken,emails:JSON.stringify(d),ipn_id:a("#"+b.gateway+"-custom").val(),symbol:b.symbol},context:document.body,success:function(a){c.handleEmailSubmitAJAXResponse(a,b)}})}else b.genericErrorModal(b.mdlstr.novalidemailsentered,b.mdlstr.novalidemailsentered_desc,"no-valid-emails-entered"),a("#dimmer").css("display","none")},buildForm:function(c,d,f){var g=this;g.enabled?(a("#dimmer").css("display","block"),g.enabled=!1,c.text(d.enrolothers),c.removeClass("disable-mr").addClass("enable-mr"),a(".mr-email-line").remove(),a("#multiple-registration-btn-container img.iconhelp").css("display","inline-block"),a.ajax({url:e.wwwroot+"/enrol/payment/ajax/single_enrol.php",method:"POST",data:{prepaytoken:f.prepayToken,instanceid:f.instanceid},success:function(c){var d=JSON.parse(c);if(a("#dimmer").css("display","none"),d.success)f.subtotal=d.subtotal,f.updateCostView();else{var e=a("#error-modal-trigger");e.off(),b.create({type:b.types.DEFAULT,body:d.failmessage,closebuttontitle:f.mdlstr.dismiss},e).done(function(a){f.removeDimmer(a)}),a("#error-modal-trigger").click()}},error:function(){alert(f.mdlstr.errcommunicating)}})):(g.enabled=!0,g.nextEmailID=1,c.text(d.cancelenrolothers),c.removeClass("enable-mr").addClass("disable-mr"),a("#multiple-registration-container").html(this.makeEmailEntryLine(d)),g.addPlusClickHandler(a(".plus-container"),d),a("#multiple-registration-btn-container img.iconhelp").css("display","none"))}},Discount:{checkDiscountCode:function(b){var c=a("#discountcode").val(),d=e.wwwroot+"/enrol/payment/ajax/check_discount.php";a.ajax({url:d,data:{discountcode:c,instanceid:b.instanceid,prepaytoken:b.prepayToken},context:document.body,success:function(c){var d=JSON.parse(c);d.success?(a("#discount-dimmer").css("display","block"),b.subtotal=d.subtotal,b.updateCostView(),a(".discount-threshold-info").css("display","block")):(a("#dimmer").css("display","block"),b.genericErrorModal(b.mdlstr.incorrectdiscountcode,d.failmessage,"invalid-code-modal"))},error:function(){a("#dimmer").css("display","block"),b.genericErrorModal(b.mdlstr.incorrectdiscountcode,b.mdlstr.incorrectdiscountcode_desc,"invalid-code-modal")}})}},checkoutFinal:function(){if(this.updateCostView(),"paypal"===this.gateway)a("#paypal-form input[name=amount]").val(this.subtotal),a("#paypal-form input[name=tax]").val(this.taxAmount),a("#paypal-form").submit();else{if("stripe"!==this.gateway)throw new Error(this.mdlstr.invalidgateway);a("#stripe-form input[name=amount]").val(this.getTaxedAmount()),a("#stripe-form input[name=tax]").val(this.taxAmount),this.stripeCheckout()}},getTaxedAmount:function(){return(parseFloat(this.subtotal)+parseFloat(this.taxAmount)).toFixed(2)},updateCostView:function(){this.taxAmount=Number.parseFloat(this.subtotal*this.taxPercent).toFixed(2),a("span.localisedcost-untaxed").text(Number.parseFloat(this.subtotal).toFixed(2)),a("span.localisedcost").text(this.getTaxedAmount()),a("span.subtotal-display").text(this.getTaxedAmount()),a("span.taxamountstring").text(Number.parseFloat(this.taxAmount).toFixed(2)),a("span#banktransfer-cost").text(this.symbol+this.getTaxedAmount())},stripeCheckout:function(){var b=this;a.getScript("https://checkout.stripe.com/checkout.js",function(){var c=StripeCheckout.configure({key:b.stripePublishableKey,image:b.stripeLogo||"https://stripe.com/img/documentation/checkout/marketplace.png",locale:"auto",billingAddress:b.billingAddressRequired,shippingAddress:b.shippingAddressRequired,email:b.userEmail||null,allowRememberMe:!1,token:function(b){a("#stripe-form").append('<input type="hidden" name="stripeToken" value="'+b.id+'" />').append('<input type="hidden" name="stripeTokenType" value="'+b.type+'" />').append('<input type="hidden" name="stripeEmail" value="'+b.email+'" />').submit()}});c.open({name:decodeURIComponent(b.courseFullName),description:b.mdlstr.totalenrolmentfee+" "+b.symbol+b.getTaxedAmount()+" "+b.currency,zipCode:b.validateZipCode?"true":"false",amount:Math.floor(100*Number.parseFloat(b.getTaxedAmount())),currency:b.currency,closed:function(){a("#dimmer").css("display","none")}})}).fail(function(){throw new Error("Could not load Stripe checkout library.")})},genericErrorModal:function(c,d,e){var f=this;0==a("#"+e).length&&a("#moodle-modals").append('<a id="'+e+'"></a>');var g=a("#moodle-modals #"+e);g.off(),b.create({type:b.types.DEFAULT,title:c,body:d},g).done(function(a){f.removeDimmer(a)}),g.click()},removeDimmer:function(b){b.getRoot().on(c.destroyed,function(){a("#dimmer").css("display","none")}),b.getRoot().on(c.cancel,function(){a("#dimmer").css("display","none")}),b.getRoot().on(c.hidden,function(){a("#dimmer").css("display","none")})},initClickHandlers:function(){var b=this;a("#apply-discount").click(function(){b.Discount.checkDiscountCode(b)}),a("#multiple-registration-btn").click(function(){b.MultipleRegistration.buildForm(a(this),b.mdlstr,b)}),a(".payment-checkout").click(function(c){a("#dimmer").css("display","block"),c.preventDefault(),"paypal-button"===c.target.id?b.gateway="paypal":"stripe-button"===c.target.id&&(b.gateway="stripe"),b.MultipleRegistration.enabled?b.MultipleRegistration.verifyAndSubmit(b):b.checkoutFinal()})},loadStrings:function(a,b){for(var c=[],e=0;e<a.length;e++)c.push({key:a[e],component:"enrol_payment"});var f=d.get_strings(c);f.done(function(c){for(var d=[],e=0;e<a.length;e++)d[a[e]]=c[e];b(d)})},init:function(b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q){var r=this,s=["discounttypeerror","discountamounterror","invalidgateway","errcommunicating","addaregistrant","removearegistrant","enrolothers","cancelenrolothers","confirmpurchase","continue","dismiss","invalidpaymentprovider","novalidemailsentered","novalidemailsentered_desc","totalenrolmentfee","error","incorrectdiscountcode","incorrectdiscountcode_desc"];r.loadStrings(s,function(s){r.mdlstr=s,r.originalCost=parseFloat(d),r.taxPercent=parseFloat(i),r.subtotal=parseFloat(j),r.taxAmount=parseFloat(i*d),r.instanceid=b,r.stripePublishableKey=c,r.courseFullName=f,r.shippingAddressRequired=1==g,r.prepayToken=e,r.stripeLogo=h,r.validateZipCode=1==k,r.billingAddressRequired=1==l,r.userEmail=m,r.currency=n,r.symbol=o,r.discountCodeRequired=1==p,r.discountThreshold=q,r.initClickHandlers(),r.updateCostView(),a("#dimmer").css("display","none")})}};return g});